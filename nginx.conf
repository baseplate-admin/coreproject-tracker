worker_processes auto;
events {
    worker_connections 1024;
}

http {
    # Docker networks to trust for real IP
    # Docker bridge network
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    # Docker host
    set_real_ip_from 127.0.0.1;
    # IPv6 ranges
    set_real_ip_from fc00::/7;
    set_real_ip_from fe80::/10;
    
    # Real IP configuration
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # HTTP server block
    server {
        listen 8000;
        listen [::]:8000 ipv6only=on;

        # Route WebSocket traffic
        location / {
            proxy_pass http://tracker_http;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Forward real client IP including IPv6
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Explicitly preserve IPv6 address format
            proxy_set_header X-Forwarded-For-IPv6 $remote_addr;
            proxy_set_header X-Real-IP-IPv6 $remote_addr;

            # Route to HTTP backend if not WebSocket
            proxy_set_header Connection "";
        }
    }

    # Upstream for HTTP
    upstream tracker_http {
        server tracker:9000;
    }

    # Upstream for WebSocket
    upstream tracker_ws {
        server tracker:8080;
    }
}

# Stream block for UDP traffic
stream {
    # Docker networks to trust
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    set_real_ip_from 127.0.0.1;
    set_real_ip_from fc00::/7;
    set_real_ip_from fe80::/10;

    server {
        listen 8000 udp;
        listen [::]:8000 udp ipv6only=on;
        proxy_pass tracker_udp;
        proxy_protocol on;
    }

    # Upstream for UDP
    upstream tracker_udp {
        server tracker:8000;
    }
}