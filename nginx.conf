worker_processes auto;
events {
    worker_connections 1024;
}

http {
    # Enable real IP forwarding
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;  # Trust all IPv4 sources
    set_real_ip_from ::/0;       # Trust all IPv6 sources

    # HTTP server block for IPv4 and IPv6
    server {
        listen 8000;           # Listen for IPv4
        listen [::]:8000;      # Listen for IPv6

        # Route WebSocket traffic (Upgrade header) to the WebSocket backend
        location / {
            proxy_pass http://tracker_http;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Forward real client IP
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Route to HTTP backend if not WebSocket
            proxy_set_header Connection "";
        }
    }

    # Upstream for HTTP
    upstream tracker_http {
        server tracker:9000;
    }

    # Upstream for WebSocket
    upstream tracker_ws {
        server tracker:8080;
    }
}

# Stream block for UDP traffic with IPv4 and IPv6
stream {
    # Enable proxy protocol for real IP
    server {
        listen 8000 udp;        # Listen for IPv4
        listen [::]:8000 udp;   # Listen for IPv6
        proxy_pass tracker_udp;
        proxy_protocol on;      # Enable proxy protocol for passing real IP
    }

    # Upstream for UDP
    upstream tracker_udp {
        server tracker:8000;
    }
}
